<!DOCTYPE html>
<html>
    <head>
        <title>vTuberry</title>
        <style>
            body {
                margin: 0px;
                background-color: #00FF00;
            }
            #canvas {
                display: inline-block;
                width: 512px;
                height: 512px;
            }
            .settingsContainer {
                display: inline-block;
            }
            .settings {
                flex-direction: column;
                display: flex;
            }
            .rootContainer {
                display: flex;
                flex-direction: row;
            }
        </style>
    </head>
    <body>
        <span id="debug-text" style="position: absolute; top: 0px; left: 0px; visibility: collapse;"></span>
        <div class="rootContainer">
            <Button id="grant-button" style="position: absolute; top: 0px; left: 0px;">Grant microphone access</Button>
            <canvas id="canvas" width="512" height="512" style="visibility: hidden;"></canvas>
            <div class="settings">
                <input type="file" id="idle-input" accept="image/*">
                <input type="file" id="talking-input" accept="image/*">
                <Button id="save-settings-button">Save settings</Button>
                <a style="display: none" id="json-export-download"></a>
                <input type="file" id="load-settings-input" accept="application/json">
            </div>
        </div>
        <script>
            var canvas = document.getElementById('canvas');
            var grantMicrophoneButton = document.getElementById('grant-button');
            var context = canvas.getContext('2d');
            var debugText = document.getElementById('debug-text');
            const WIDTH = 512;
            const HEIGHT = 512;
            const ANIM_DURATION = 450;
            context.width = WIDTH;
            context.HEIGHT = HEIGHT;
            
            var analyser = null;

            async function getMedia(constraints) {
                try {
                    var media = await navigator.mediaDevices.getUserMedia(constraints);
                    //alert('granted');
                    var audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    var sourceMicro = audioContext.createMediaStreamSource(media);
                    analyser = audioContext.createAnalyser();
                    sourceMicro.connect(analyser);
                    
                } catch (err) {
                    //alert('denied');
                }
            }

            function initMicrophone() {
                getMedia({audio: true, video: false});
            }

            grantMicrophoneButton.addEventListener('click', ev => {
                initMicrophone();
                ev.target.remove();
                canvas.style = '';
            });

            var avatar = {
                emotes: {
                    idle: {
                        img: new Image(),
                        src: null,
                    },
                    talking: {
                        img: new Image(),
                        src: null,
                    }
                },
                currentEmote: null,
                timestampLastEmote: 0, // timestamp of last emote
            };
            const draw = (timestamp) => {
                // clear canvas
                context.clearRect(0, 0, WIDTH, HEIGHT);
                context.fillStyle = '#0000' + (Math.floor(timestamp / 10.0) % 255).toString(16).padStart(2, "0");
                //context.fillRect(0, 0, WIDTH, HEIGHT);
                var currentAvatar = avatar.currentEmote;
                if (currentAvatar) {
                    context.src = currentAvatar.img;

                    context.resetTransform();
                    context.translate(WIDTH / 2, HEIGHT / 2);
                    // add lerp
                    var progress = (timestamp - avatar.timestampLastEmote) / ANIM_DURATION;
                    progress = Math.min(progress, 1.0);
                    progress = 1 - progress;
                    progress *= progress;
                    progress = 1 - progress;
                    var lerpedX = 0.9 + (0.1) * progress;
                    var lerpedY = 1.1 + (-0.1) * progress;
                    context.scale(lerpedX, lerpedY);
                    context.translate(-WIDTH / 2, -HEIGHT / 2);

                    context.drawImage(context.src, 0, 0);
                }
                window.requestAnimationFrame(draw);
            }

            // Settings
            document.getElementById("idle-input").addEventListener("change", ev => {
                var idleFileReader = new FileReader();
                idleFileReader.onload = function (e) {
                    avatar.emotes.idle.img.src = e.target.result;
                    avatar.emotes.idle.src = e.target.result;
                }
                idleFileReader.readAsDataURL(ev.target.files[0]);
            });
            document.getElementById("talking-input").addEventListener("change", ev => {
                var talkingFileReader = new FileReader();
                talkingFileReader.onload = function (e) {
                    avatar.emotes.talking.img.src = e.target.result;
                    avatar.emotes.talking.src = e.target.result;
                }
                talkingFileReader.readAsDataURL(ev.target.files[0]);
            });
            document.getElementById("save-settings-button").addEventListener("click", ev => {
                var a = document.getElementById("json-export-download");
                var file = new Blob([JSON.stringify(avatar)], {type: "application/json"});
                a.href = URL.createObjectURL(file);
                a.download = "settings.json";
                a.click();
            });
            document.getElementById("load-settings-input").addEventListener("change", ev => {
                var fileReader = new FileReader();
                fileReader.onload = function (e) {
                    var json = JSON.parse(e.target.result);
                    avatar = json;
                    avatar.emotes.idle.img = new Image();
                    avatar.emotes.idle.img.src = avatar.emotes.idle.src;
                    avatar.emotes.talking.img = new Image();
                    avatar.emotes.talking.img.src = avatar.emotes.talking.src;
                    avatar.currentEmote = null;
                    avatar.timestampLastEmote = window.performance.now();
                }
                fileReader.readAsText(ev.target.files[0]);
            });

            // draw loop
            window.addEventListener('load', () => {
                window.requestAnimationFrame(draw);

                debugText.innerHTML = 'debug';
            });

            // process loop
            setInterval(function() {
                if (analyser) {
                    // get average level from analyser
                    var sum = 0;
                    var bufferLength = Math.floor(analyser.frequencyBinCount / 20);
                    var frequencyData = new Uint8Array(bufferLength);
                    analyser.getByteFrequencyData(frequencyData);
                    for (var i = 0; i < bufferLength; i++) {
                        sum += frequencyData[i];
                    }
                    var average = sum / bufferLength;
                    // debug
                    debugText.innerHTML = '' + average;

                    // set current emote
                    var speaking = average > 100;
                    // check if there is a change
                    var emote = speaking ? avatar.emotes.talking : avatar.emotes.idle;
                    if (emote != avatar.currentEmote) {
                        avatar.currentEmote = emote;
                        if (speaking) {
                            avatar.timestampLastEmote = window.performance.now();
                        }
                    }
                }
            }, 1000 / 30);
        </script>
    </body>
</html>